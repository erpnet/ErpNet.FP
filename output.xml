<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="All">

    <PropertyGroup>
        <OutputPath>Output</OutputPath>
        <PublishRoot>Published</PublishRoot>
        <Version>1.1.0.1683</Version>
    </PropertyGroup>

    <ItemGroup>
        <WixNamespace Include="wix">
            <Prefix>wix</Prefix>
            <Uri>http://wixtoolset.org/schemas/v4/wxs</Uri>
        </WixNamespace>
    </ItemGroup>

    <ItemGroup>
        <TargetPlatform Include="win-x86" />
        <TargetPlatform Include="win-x64" />
        <TargetPlatform Include="osx-x64" />
        <TargetPlatform Include="linux-x64" />
        <TargetPlatform Include="linux-arm" />
    </ItemGroup>

    <UsingTask TaskName="RegexReplace" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
        <ParameterGroup>
            <File ParameterType="System.String" Required="true" />
            <Pattern ParameterType="System.String" Required="true" />
            <Value ParameterType="System.String" Required="true" />
        </ParameterGroup>
        <Task>
            <Code Type="Fragment" Language="cs">
                <![CDATA[
          string content = System.IO.File.ReadAllText(File);
          string newContent = System.Text.RegularExpressions.Regex.Replace(content, Pattern, Value);
          System.IO.File.WriteAllText(File, newContent);
        ]]>
            </Code>
        </Task>
    </UsingTask>

    <Target Name="PrepareForRelease">
        <Message Importance="high" Text="=== STEP 1: Preparing Release $(Version) ===" />

        <XmlPoke
          XmlInputPath="ErpNet.FP.Setup\Product.wxs"
          Query="/wix:Wix/wix:Package/@Version"
          Namespaces="&lt;Namespace Prefix='wix' Uri='http://wixtoolset.org/schemas/v4/wxs' /&gt;"
          Value="$(Version)" />

        <XmlPoke
          Condition="Exists('Directory.Build.props')"
          XmlInputPath="Directory.Build.props"
          Query="/Project/PropertyGroup/Version"
          Value="$(Version)" />

        <GetFileHash Files="ErpNet.FP.Server\wwwroot\app.js">
            <Output TaskParameter="Items" ItemName="AppJsInfo" />
        </GetFileHash>
        <GetFileHash Files="ErpNet.FP.Server\wwwroot\index.css">
            <Output TaskParameter="Items" ItemName="IndexCssInfo" />
        </GetFileHash>

        <PropertyGroup>
            <AppJsHash>%(AppJsInfo.FileHash)</AppJsHash>
            <IndexCssHash>%(IndexCssInfo.FileHash)</IndexCssHash>
        </PropertyGroup>

        <Message Importance="high" Text="Hashes: app.js=$(AppJsHash) | index.css=$(IndexCssHash)" />

        <RegexReplace
          File="ErpNet.FP.Server\wwwroot\index.html"
          Pattern="app\.js\?ver=([^&quot;]+)"
          Value="app.js?ver=$(AppJsHash)" />

        <RegexReplace
          File="ErpNet.FP.Server\wwwroot\index.html"
          Pattern="index\.css\?ver=([^&quot;]+)"
          Value="index.css?ver=$(IndexCssHash)" />
    </Target>

    <Target Name="PublishToOutputPath" DependsOnTargets="PrepareForRelease">
        <Message Importance="high" Text="=== STEP 2: Publishing &amp; Zipping ===" />

        <RemoveDir Directories="$(OutputPath);$(PublishRoot)" />
        <MakeDir Directories="$(OutputPath);$(PublishRoot)" />

        <MSBuild Projects="$(MSBuildProjectFile)" Targets="PublishSinglePlatform" Properties="PlatformName=%(TargetPlatform.Identity)" />
    </Target>

    <Target Name="PublishSinglePlatform">
        <Message Text="Processing $(PlatformName)..." Importance="high" />

        <Exec Command="dotnet publish ErpNet.FP.Server\ErpNet.FP.Server.csproj -c Release -r $(PlatformName) --self-contained true -p:PublishTrimmed=false -o $(PublishRoot)\$(PlatformName)" />

        <ZipDirectory
          SourceDirectory="$(PublishRoot)\$(PlatformName)"
          DestinationFile="$(OutputPath)\$(PlatformName).zip"
          Overwrite="true" />
    </Target>

    <Target Name="BuildWindowsSetup" DependsOnTargets="PublishToOutputPath">
        <Message Importance="high" Text="=== STEP 3: Building Windows MSI ===" />

        <MSBuild
          Projects="ErpNet.FP.Setup\ErpNet.FP.Setup.wixproj"
          Properties="Configuration=Release;Platform=x86" />

        <Message Importance="high" Text="MSI file is ready in $(OutputPath)" />
    </Target>

    <Target Name="All" DependsOnTargets="PrepareForRelease;PublishToOutputPath;BuildWindowsSetup">
        <Message Importance="high" Text="=== BUILD COMPLETE! Check $(OutputPath) folder. ===" />
    </Target>

</Project>